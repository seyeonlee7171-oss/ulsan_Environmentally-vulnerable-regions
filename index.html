<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì§€ì—­ë³„ í™˜ê²½ë³´ê±´ ì·¨ì•½ì§€ìˆ˜ ì‹œê°í™” ë§µ</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    /* ===== Base Reset ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, "Malgun Gothic", "ë§‘ì€ ê³ ë”•", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 18px;
      color: #111827;
    }

    /* ===== Layout Card ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 14px 40px rgba(0,0,0,0.28);
      min-height: calc(100vh - 36px);
      display: flex;
      flex-direction: column;
    }

    /* ===== Header ===== */
    .header {
      padding: 26px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    .header-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .header-text{
      min-width:0;
    }
    .header h1 {
      font-size: 22px;
      letter-spacing: -0.2px;
      margin-bottom: 6px;
    }
    .header p {
      opacity: 0.92;
      font-size: 14px;
      line-height: 1.4;
    }

    /* ===== Header Logo ===== */
    .header-logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.18);
      text-decoration:none;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
      flex-shrink: 0;
    }
    .header-logo:hover{
      background: rgba(255,255,255,0.22);
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    }
    .header-logo img{
      height: 34px;
      width: auto;
      display:block;
    }

    /* ===== Main grid ===== */
    .content {
      flex: 1;
      display: grid;
      grid-template-columns: 340px 1fr;
      min-height: 0;
    }

    /* ===== Panel ===== */
    .panel {
      padding: 18px 18px;
      background: #f8f9fa;
      border-right: 1px solid #e9ecef;
      min-height: 0;
    }
    .panel-card {
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .label {
      display: block;
      font-weight: 700;
      font-size: 13px;
      color: #374151;
      margin: 10px 0 8px;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, button {
      height: 42px;
      border-radius: 10px;
      font-size: 14px;
    }

    select {
      width: 100%;
      padding: 0 12px;
      border: 2px solid #667eea;
      background: #fff;
      color: #111827;
      outline: none;
      transition: all .22s ease;
      cursor: pointer;
    }
    select:hover {
      border-color: #764ba2;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.25);
    }
    select:focus {
      border-color: #764ba2;
      box-shadow: 0 0 0 4px rgba(118, 75, 162, 0.15);
    }

    .btn {
      width: 100%;
      border: none;
      cursor: pointer;
      font-weight: 800;
      color: #fff;
      background: #667eea;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .btn:hover {
      background: #764ba2;
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(102,126,234,0.28);
    }
    .btn:active {
      transform: translateY(0px);
      box-shadow: none;
    }
    #exportBtn {
      background: #10b981;
    }
    #exportBtn:hover {
      background: #059669;
      box-shadow: 0 10px 18px rgba(16,185,129,0.28);
    }

    /* ===== Toggle Button ===== */
    .toggle-container {
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .toggle-label {
      font-weight: 700;
      font-size: 13px;
      color: #374151;
    }
    .toggle-switch {
      position: relative;
      width: 52px;
      height: 28px;
      background: #e5e7eb;
      border-radius: 14px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .toggle-switch.active {
      background: #667eea;
    }
    .toggle-knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle-switch.active .toggle-knob {
      transform: translateX(24px);
    }
    .toggle-status {
      font-size: 12px;
      color: #6b7280;
      font-weight: 600;
    }

    .hint {
      margin-top: 12px;
      font-size: 12.5px;
      color: #6b7280;
      line-height: 1.45;
    }
    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(102, 126, 234, 0.12);
      color: #4f46e5;
      font-weight: 700;
      font-size: 12px;
      margin-right: 6px;
    }

    /* ===== Map area ===== */
    .map-wrap {
      padding: 16px;
      background: #fff;
      min-height: 0;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 520px;
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.10);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
    }

    /* ===== Footer ===== */
    .footer {
      padding: 14px 18px;
      text-align: center;
      color: #6b7280;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
      font-size: 12.5px;
    }

    /* ===== Leaflet legend style ===== */
    .legend {
      background: rgba(255,255,255,0.96);
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
      backdrop-filter: blur(6px);
    }
    .legend .title {
      font-weight: 800;
      margin-bottom: 8px;
      color: #111827;
      font-size: 13px;
    }
    .legend .item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 6px 0;
      font-size: 12.5px;
      color: #374151;
    }
    .legend .swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.22);
    }
    .legend .meta {
      margin-top: 8px;
      font-size: 11.5px;
      color: #6b7280;
    }

    /* ===== Responsive ===== */
    @media (max-width: 980px) {
      body { padding: 10px; }
      .content { grid-template-columns: 1fr; }
      .panel { border-right: none; border-bottom: 1px solid #e9ecef; }
      #map { min-height: 520px; }

      .header-inner{ align-items:flex-start; }
      .header-logo img{ height: 28px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-inner">
        <div class="header-text">
          <h1>ì§€ì—­ë³„ í™˜ê²½ë³´ê±´ ì·¨ì•½ì§€ìˆ˜ ì‹œê°í™” ë§µ</h1>
          <p>í–‰ì •ë™ë³„ ì§€í‘œë¥¼ ì„ íƒí•´ ë‹¨ê³„í˜• ìƒ‰ìƒ ì§€ë„ë¡œ í™•ì¸í•©ë‹ˆë‹¤.</p>
        </div>

        <!-- ìš¸ì‚°ì—°êµ¬ì› ë¡œê³  - í´ë¦­ ì‹œ ì‚¬ì´íŠ¸ë¡œ ì´ë™ -->
        <a class="header-logo" href="https://www.uri.re.kr/" target="_blank" rel="noopener">
          <img src="./assets/logo.png" alt="ìš¸ì‚°ì—°êµ¬ì› ë¡œê³ " />
        </a>
      </div>
    </div>

    <div class="content">
      <aside class="panel">
        <div class="panel-card">
          <div class="row" style="margin-bottom: 6px;">
            <span class="pill">INTERACTIVE</span>
            <span class="hint" style="margin-top:0;">ë“œë¡­ë‹¤ìš´ì—ì„œ ë³€ìˆ˜ë¥¼ ë°”ê¾¸ë©´ ì§€ë„ê°€ ì¦‰ì‹œ ê°±ì‹ ë©ë‹ˆë‹¤.</span>
          </div>

          <label class="label" for="varSelect">ë³€ìˆ˜ ì„ íƒ</label>
          <select id="varSelect"></select>

          <!-- ì •ê·œí™” ON/OFF í† ê¸€ -->
          <div class="toggle-container">
            <span class="toggle-label">ì •ê·œí™”</span>
            <div class="toggle-switch" id="normalizeToggle">
              <div class="toggle-knob"></div>
            </div>
            <span class="toggle-status" id="normalizeStatus">OFF</span>
          </div>

          <div class="hint" style="margin-top: 12px;">
            <div>â€» ì •ê·œí™” ON: ëª¨ë“  ë³€ìˆ˜ë¥¼ 1~10 ë²”ìœ„ë¡œ ë³€í™˜í•˜ì—¬ ë¹„êµ ê°€ëŠ¥</div>
            <div style="margin-top:6px;">â€» ì •ê·œí™” OFF: ì›ë³¸ ë°ì´í„° ê°’ ê·¸ëŒ€ë¡œ í‘œì‹œ</div>
          </div>

          <div class="hint" style="margin-top: 12px;">
            <div>ë°ì´í„° íŒŒì¼: <code>ulsan_dong_indicators.geojson</code></div>
            <div style="margin-top:6px;">â€» ë¡œë”©ì´ ëŠë¦¬ë©´ GeoJSON ìš©ëŸ‰(geometry/ì†ì„±)ì„ ì¤„ì´ëŠ” ë°©ì‹ìœ¼ë¡œ ê°œì„  ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
          </div>

          <div style="margin-top: 14px;">
            <button class="btn" id="resetBtn" type="button">ì§€ë„ ì´ˆê¸°í™”(ì „ì²´ë³´ê¸°)</button>
          </div>

          <div style="margin-top: 10px;">
            <button class="btn" id="exportBtn" type="button" style="background: #10b981;">ğŸ“¸ ì´ë¯¸ì§€ë¡œ ì €ì¥</button>
          </div>
        </div>
      </aside>

      <main class="map-wrap">
        <div id="map"></div>
      </main>
    </div>

    <div class="footer">
      ì§€ì—­ë³„ í™˜ê²½ë³´ê±´ ì·¨ì•½ì§€ìˆ˜ ì‹œê°í™” ë§µ Â· ì •ì  ì›¹(HTML/JS) Â· Leaflet ê¸°ë°˜
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // ====== ì„¤ì • ======
    const GEOJSON_URL = "./ulsan_dong_indicators.geojson";
    const NAME_FIELD = "ADM_NM";
    const K_VALUE = 10; // ê³ ì •ê°’

    let map = L.map("map").setView([35.55, 129.30], 11);
    const base = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    let geoLayer = null;
    let legendControl = null;
    let geoData = null;
    let isNormalized = false; // ì •ê·œí™” ìƒíƒœ

    function getColor(idx, k) {
      const ramps = {
        5:  ["#ffffcc","#fed976","#feb24c","#fd8d3c","#e31a1c"],
        7:  ["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#f03b20","#bd0026"],
        10: ["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026","#4d0018"]
      };
      const pal = ramps[k] || ramps[10];
      return pal[Math.min(idx, pal.length - 1)];
    }

    function fmt(v) {
      if (v === null || v === undefined || Number.isNaN(v)) return "NA";
      const n = parseFloat(v);
      if (isNormalized) {
        return Math.round(n).toString(); // ì •ê·œí™”ëœ ê°’ì€ ì •ìˆ˜ë¡œ í‘œì‹œ
      }
      return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function computeNaturalBreaks(values, k) {
      return ss.jenks(values, k); // ê¸¸ì´ k+1 ê²½ê³„
    }

    // Min-Max ì •ê·œí™” í•¨ìˆ˜ (1~10 ë²”ìœ„)
    function normalizeToRange(values) {
      const validVals = values.filter(v => v !== null && v !== undefined && !Number.isNaN(v));
      if (validVals.length === 0) return values;
      
      const minVal = Math.min(...validVals);
      const maxVal = Math.max(...validVals);
      
      if (minVal === maxVal) {
        // ëª¨ë“  ê°’ì´ ê°™ìœ¼ë©´ ì¤‘ê°„ê°’(5.5) ë°˜í™˜
        return values.map(v => (v !== null && v !== undefined && !Number.isNaN(v)) ? 5.5 : v);
      }
      
      return values.map(v => {
        if (v === null || v === undefined || Number.isNaN(v)) return v;
        return 1 + ((v - minVal) / (maxVal - minVal)) * 9;
      });
    }

    function buildLegend(breaks, k, varName) {
      if (legendControl) legendControl.remove();

      legendControl = L.control({ position: "bottomright" });
      legendControl.onAdd = function () {
        const div = L.DomUtil.create("div", "legend");
        const displayName = varName;
        div.innerHTML = `<div class="title">${displayName}</div>`;
        
        if (isNormalized) {
          // ì •ê·œí™”ëœ ê²½ìš° level í‘œê¸°
          for (let i = 0; i < k; i++) {
            const color = getColor(i, k);
            div.innerHTML += `
              <div class="item">
                <span class="swatch" style="background:${color}"></span>
                <span>${i + 1} level</span>
              </div>`;
          }
          div.innerHTML += `<div class="meta">Level 1 (ë‚®ìŒ) ~ Level ${k} (ë†’ìŒ)</div>`;
        } else {
          // ì›ë³¸ ê°’ì¸ ê²½ìš° ê¸°ì¡´ ë°©ì‹
          for (let i = 0; i < k; i++) {
            const from = breaks[i];
            const to = breaks[i + 1];
            const color = getColor(i, k);
            div.innerHTML += `
              <div class="item">
                <span class="swatch" style="background:${color}"></span>
                <span>${fmt(from)} â€“ ${fmt(to)}</span>
              </div>`;
          }
          div.innerHTML += `<div class="meta">Natural Breaks, k=${k}</div>`;
        }
        return div;
      };
      legendControl.addTo(map);
    }

    function styleFeature(feature, varName, breaks, k) {
      let v = feature.properties[varName];
      
      // ì •ê·œí™”ëœ ê°’ ì‚¬ìš© (ë¯¸ë¦¬ ê³„ì‚°ë˜ì–´ propertiesì— ì €ì¥ë¨)
      if (isNormalized && feature.properties[varName + '_normalized'] !== undefined) {
        v = feature.properties[varName + '_normalized'];
      }
      
      if (v === null || v === undefined || Number.isNaN(v)) {
        return { color: "#9ca3af", weight: 1, fillOpacity: 0.25, fillColor: "#e5e7eb" };
      }
      let idx = k - 1;
      for (let i = 0; i < k; i++) {
        if (v <= breaks[i + 1]) { idx = i; break; }
      }
      return { color: "#6b7280", weight: 1, fillOpacity: 0.78, fillColor: getColor(idx, k) };
    }

    function render(varName) {
      if (!geoData) return;

      // ì›ë³¸ ê°’ ì¶”ì¶œ
      const rawVals = geoData.features
        .map(f => f.properties[varName])
        .filter(v => typeof v === "number" && !Number.isNaN(v));

      if (rawVals.length === 0) {
        alert(`'${varName}' ë³€ìˆ˜ì— ìœ íš¨í•œ ìˆ«ìê°’ì´ ì—†ìŠµë‹ˆë‹¤.`);
        return;
      }

      // ì •ê·œí™” ì ìš©
      let vals = rawVals;
      if (isNormalized) {
        const allVals = geoData.features.map(f => f.properties[varName]);
        const normalized = normalizeToRange(allVals);
        
        // ì •ê·œí™”ëœ ê°’ì„ ê° featureì˜ propertiesì— ì„ì‹œ ì €ì¥
        geoData.features.forEach((f, idx) => {
          f.properties[varName + '_normalized'] = normalized[idx];
        });
        
        vals = normalized.filter(v => typeof v === "number" && !Number.isNaN(v));
      }

      const uniq = Array.from(new Set(vals)).length;
      const kEff = Math.max(2, Math.min(K_VALUE, uniq));
      const breaks = computeNaturalBreaks(vals, kEff); // kEff+1

      if (geoLayer) geoLayer.remove();

      geoLayer = L.geoJSON(geoData, {
        style: (f) => styleFeature(f, varName, breaks, kEff),
        onEachFeature: (feature, layer) => {
          const nm = feature.properties[NAME_FIELD] ?? "";
          let v = feature.properties[varName];
          let displayValue = v;
          
          // íˆ´íŒì— í‘œì‹œí•  ê°’ ê²°ì •
          if (isNormalized && feature.properties[varName + '_normalized'] !== undefined) {
            displayValue = feature.properties[varName + '_normalized'];
            const level = Math.round(displayValue);
            layer.bindTooltip(`<b>${nm}</b><br/>${varName}: ${level} level`, { sticky: true });
          } else {
            layer.bindTooltip(`<b>${nm}</b><br/>${varName}: ${fmt(displayValue)}`, { sticky: true });
          }
        }
      }).addTo(map);

      try {
        map.fitBounds(geoLayer.getBounds(), { padding: [14, 14] });
      } catch (e) {}

      buildLegend(breaks, kEff, varName);
    }

    // ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜
    function exportMapAsImage() {
      const mapElement = document.getElementById('map');
      const varSelect = document.getElementById('varSelect');
      const varName = varSelect.value;
      const normalizeText = isNormalized ? '_ì •ê·œí™”' : '';
      
      // html2canvasë¡œ ì§€ë„ ìº¡ì²˜
      html2canvas(mapElement, {
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        scale: 2 // ê³ í•´ìƒë„
      }).then(canvas => {
        // Canvasë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
        const link = document.createElement('a');
        const timestamp = new Date().toISOString().slice(0, 10);
        link.download = `ìš¸ì‚°_í™˜ê²½ë³´ê±´ì·¨ì•½ì§€ìˆ˜_${varName}${normalizeText}_${timestamp}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      }).catch(err => {
        console.error('ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:', err);
        alert('ì´ë¯¸ì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      });
    }

    function populateVarsFromGeoJSON(geojson) {
      const props = geojson.features?.[0]?.properties || {};
      const candidates = Object.keys(props).filter(k => 
        k !== NAME_FIELD && 
        k !== "join_key" && 
        !k.endsWith("_normalized") // ì •ê·œí™”ëœ ì„ì‹œ í•„ë“œ ì œì™¸
      );
      const vars = candidates.filter(vn =>
        geojson.features.some(f => typeof f.properties[vn] === "number" && !Number.isNaN(f.properties[vn]))
      );
      return vars;
    }

    async function init() {
      const res = await fetch(GEOJSON_URL);
      geoData = await res.json();

      const varSelect = document.getElementById("varSelect");
      const resetBtn = document.getElementById("resetBtn");
      const exportBtn = document.getElementById("exportBtn");
      const normalizeToggle = document.getElementById("normalizeToggle");
      const normalizeStatus = document.getElementById("normalizeStatus");

      const vars = populateVarsFromGeoJSON(geoData);
      if (vars.length === 0) {
        varSelect.innerHTML = `<option value="">(í‘œì‹œí•  ë³€ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤)</option>`;
        return;
      }

      varSelect.innerHTML = vars.map(v => `<option value="${v}">${v}</option>`).join("");

      const defaultVar = vars.includes("ì¸êµ¬ë°€ë„") ? "ì¸êµ¬ë°€ë„" : vars[0];
      varSelect.value = defaultVar;

      render(defaultVar);

      // ë³€ìˆ˜ ì„ íƒ ë³€ê²½ ì‹œ
      varSelect.addEventListener("change", () => render(varSelect.value));

      // ì§€ë„ ì´ˆê¸°í™” ë²„íŠ¼
      resetBtn.addEventListener("click", () => {
        if (geoLayer) map.fitBounds(geoLayer.getBounds(), { padding: [14, 14] });
      });

      // ì´ë¯¸ì§€ ë‚´ë³´ë‚´ê¸° ë²„íŠ¼
      exportBtn.addEventListener("click", () => {
        exportMapAsImage();
      });

      // ì •ê·œí™” í† ê¸€
      normalizeToggle.addEventListener("click", () => {
        isNormalized = !isNormalized;
        normalizeToggle.classList.toggle("active");
        normalizeStatus.textContent = isNormalized ? "ON" : "OFF";
        render(varSelect.value);
      });
    }

    init();
  </script>
</body>
</html>
