<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>지역별 환경보건 취약지수 시각화 맵</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    /* ===== Base Reset ===== */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, "Malgun Gothic", "맑은 고딕", sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 18px;
      color: #111827;
    }

    /* ===== Layout Card ===== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 14px 40px rgba(0,0,0,0.28);
      min-height: calc(100vh - 36px);
      display: flex;
      flex-direction: column;
    }

    /* ===== Header ===== */
    .header {
      padding: 26px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    .header-inner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    .header-text{
      min-width:0;
    }
    .header h1 {
      font-size: 22px;
      letter-spacing: -0.2px;
      margin-bottom: 6px;
    }
    .header p {
      opacity: 0.92;
      font-size: 14px;
      line-height: 1.4;
    }

    /* ===== Header Logo ===== */
    .header-logo{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.18);
      text-decoration:none;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
      flex-shrink: 0;
    }
    .header-logo:hover{
      background: rgba(255,255,255,0.22);
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(0,0,0,0.18);
    }
    .header-logo img{
      height: 34px;
      width: auto;
      display:block;
    }

    /* ===== Main grid ===== */
    .content {
      flex: 1;
      display: grid;
      grid-template-columns: 340px 1fr;
      min-height: 0;
    }

    /* ===== Panel ===== */
    .panel {
      padding: 18px 18px;
      background: #f8f9fa;
      border-right: 1px solid #e9ecef;
      min-height: 0;
    }
    .panel-card {
      background: #fff;
      border: 1px solid #e9ecef;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.06);
    }
    .label {
      display: block;
      font-weight: 700;
      font-size: 13px;
      color: #374151;
      margin: 10px 0 8px;
    }

    .row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    select, button {
      height: 42px;
      border-radius: 10px;
      font-size: 14px;
    }

    select {
      width: 100%;
      padding: 0 12px;
      border: 2px solid #667eea;
      background: #fff;
      color: #111827;
      outline: none;
      transition: all .22s ease;
      cursor: pointer;
    }
    select:hover {
      border-color: #764ba2;
      box-shadow: 0 2px 10px rgba(102, 126, 234, 0.25);
    }
    select:focus {
      border-color: #764ba2;
      box-shadow: 0 0 0 4px rgba(118, 75, 162, 0.15);
    }

    .btn {
      width: 100%;
      border: none;
      cursor: pointer;
      font-weight: 800;
      color: #fff;
      background: #667eea;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease;
    }
    .btn:hover {
      background: #764ba2;
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(102,126,234,0.28);
    }
    .btn:active {
      transform: translateY(0px);
      box-shadow: none;
    }

    /* ===== Toggle Button ===== */
    .toggle-container {
      margin-top: 14px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .toggle-label {
      font-weight: 700;
      font-size: 13px;
      color: #374151;
    }
    .toggle-switch {
      position: relative;
      width: 52px;
      height: 28px;
      background: #e5e7eb;
      border-radius: 14px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .toggle-switch.active {
      background: #667eea;
    }
    .toggle-knob {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 22px;
      height: 22px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle-switch.active .toggle-knob {
      transform: translateX(24px);
    }
    .toggle-status {
      font-size: 12px;
      color: #6b7280;
      font-weight: 600;
    }

    .hint {
      margin-top: 12px;
      font-size: 12.5px;
      color: #6b7280;
      line-height: 1.45;
    }
    .pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(102, 126, 234, 0.12);
      color: #4f46e5;
      font-weight: 700;
      font-size: 12px;
      margin-right: 6px;
    }

    /* ===== Map area ===== */
    .map-wrap {
      padding: 16px;
      background: #fff;
      min-height: 0;
    }
    #map {
      width: 100%;
      height: 100%;
      min-height: 520px;
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.10);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.06);
    }

    /* ===== Footer ===== */
    .footer {
      padding: 14px 18px;
      text-align: center;
      color: #6b7280;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
      font-size: 12.5px;
    }

    /* ===== Leaflet legend style ===== */
    .legend {
      background: rgba(255,255,255,0.96);
      padding: 10px 12px;
      border: 1px solid rgba(0,0,0,0.18);
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.12);
      backdrop-filter: blur(6px);
    }
    .legend .title {
      font-weight: 800;
      margin-bottom: 8px;
      color: #111827;
      font-size: 13px;
    }
    .legend .item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 6px 0;
      font-size: 12.5px;
      color: #374151;
    }
    .legend .swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(0,0,0,0.22);
    }
    .legend .meta {
      margin-top: 8px;
      font-size: 11.5px;
      color: #6b7280;
    }

    /* ===== Responsive ===== */
    @media (max-width: 980px) {
      body { padding: 10px; }
      .content { grid-template-columns: 1fr; }
      .panel { border-right: none; border-bottom: 1px solid #e9ecef; }
      #map { min-height: 520px; }

      .header-inner{ align-items:flex-start; }
      .header-logo img{ height: 28px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-inner">
        <div class="header-text">
          <h1>지역별 환경보건 취약지수 시각화 맵</h1>
          <p>행정동별 지표를 선택해 단계형 색상 지도로 확인합니다.</p>
        </div>

        <!-- 울산연구원 로고 - 클릭 시 사이트로 이동 -->
        <a class="header-logo" href="https://www.uri.re.kr/" target="_blank" rel="noopener">
          <img src="./assets/logo.png" alt="울산연구원 로고" />
        </a>
      </div>
    </div>

    <div class="content">
      <aside class="panel">
        <div class="panel-card">
          <div class="row" style="margin-bottom: 6px;">
            <span class="pill">INTERACTIVE</span>
            <span class="hint" style="margin-top:0;">드롭다운에서 변수를 바꾸면 지도가 즉시 갱신됩니다.</span>
          </div>

          <label class="label" for="varSelect">변수 선택</label>
          <select id="varSelect"></select>

          <!-- 정규화 ON/OFF 토글 -->
          <div class="toggle-container">
            <span class="toggle-label">정규화</span>
            <div class="toggle-switch" id="normalizeToggle">
              <div class="toggle-knob"></div>
            </div>
            <span class="toggle-status" id="normalizeStatus">OFF</span>
          </div>

          <div class="hint" style="margin-top: 12px;">
            <div>※ 정규화 ON: 모든 변수를 1~10 범위로 변환하여 비교 가능</div>
            <div style="margin-top:6px;">※ 정규화 OFF: 원본 데이터 값 그대로 표시</div>
          </div>

          <div class="hint" style="margin-top: 12px;">
            <div>데이터 파일: <code>ulsan_dong_indicators.geojson</code></div>
            <div style="margin-top:6px;">※ 로딩이 느리면 GeoJSON 용량(geometry/속성)을 줄이는 방식으로 개선 가능합니다.</div>
          </div>

          <div style="margin-top: 14px;">
            <button class="btn" id="resetBtn" type="button">지도 초기화(전체보기)</button>
          </div>
        </div>
      </aside>

      <main class="map-wrap">
        <div id="map"></div>
      </main>
    </div>

    <div class="footer">
      지역별 환경보건 취약지수 시각화 맵 · 정적 웹(HTML/JS) · Leaflet 기반
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>

  <script>
    // ====== 설정 ======
    const GEOJSON_URL = "./ulsan_dong_indicators.geojson";
    const NAME_FIELD = "ADM_NM";
    const K_VALUE = 10; // 고정값

    let map = L.map("map").setView([35.55, 129.30], 11);
    const base = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png", {
      attribution: '&copy; OpenStreetMap &copy; CARTO'
    }).addTo(map);

    let geoLayer = null;
    let legendControl = null;
    let geoData = null;
    let isNormalized = false; // 정규화 상태

    function getColor(idx, k) {
      const ramps = {
        5:  ["#ffffcc","#fed976","#feb24c","#fd8d3c","#e31a1c"],
        7:  ["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#f03b20","#bd0026"],
        10: ["#ffffcc","#ffeda0","#fed976","#feb24c","#fd8d3c","#fc4e2a","#e31a1c","#bd0026","#800026","#4d0018"]
      };
      const pal = ramps[k] || ramps[10];
      return pal[Math.min(idx, pal.length - 1)];
    }

    function fmt(v) {
      if (v === null || v === undefined || Number.isNaN(v)) return "NA";
      const n = parseFloat(v);
      if (isNormalized) {
        return n.toFixed(2); // 정규화된 값은 소수점 2자리
      }
      return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function computeNaturalBreaks(values, k) {
      return ss.jenks(values, k); // 길이 k+1 경계
    }

    // Min-Max 정규화 함수 (1~10 범위)
    function normalizeToRange(values) {
      const validVals = values.filter(v => v !== null && v !== undefined && !Number.isNaN(v));
      if (validVals.length === 0) return values;
      
      const minVal = Math.min(...validVals);
      const maxVal = Math.max(...validVals);
      
      if (minVal === maxVal) {
        // 모든 값이 같으면 중간값(5.5) 반환
        return values.map(v => (v !== null && v !== undefined && !Number.isNaN(v)) ? 5.5 : v);
      }
      
      return values.map(v => {
        if (v === null || v === undefined || Number.isNaN(v)) return v;
        return 1 + ((v - minVal) / (maxVal - minVal)) * 9;
      });
    }

    function buildLegend(breaks, k, varName) {
      if (legendControl) legendControl.remove();

      legendControl = L.control({ position: "bottomright" });
      legendControl.onAdd = function () {
        const div = L.DomUtil.create("div", "legend");
        const displayName = isNormalized ? `${varName} (정규화 1~10)` : varName;
        div.innerHTML = `<div class="title">${displayName}</div>`;
        for (let i = 0; i < k; i++) {
          const from = breaks[i];
          const to = breaks[i + 1];
          const color = getColor(i, k);
          div.innerHTML += `
            <div class="item">
              <span class="swatch" style="background:${color}"></span>
              <span>${fmt(from)} – ${fmt(to)}</span>
            </div>`;
        }
        div.innerHTML += `<div class="meta">Natural Breaks, k=${k}</div>`;
        return div;
      };
      legendControl.addTo(map);
    }

    function styleFeature(feature, varName, breaks, k) {
      let v = feature.properties[varName];
      
      // 정규화된 값 사용 (미리 계산되어 properties에 저장됨)
      if (isNormalized && feature.properties[varName + '_normalized'] !== undefined) {
        v = feature.properties[varName + '_normalized'];
      }
      
      if (v === null || v === undefined || Number.isNaN(v)) {
        return { color: "#9ca3af", weight: 1, fillOpacity: 0.25, fillColor: "#e5e7eb" };
      }
      let idx = k - 1;
      for (let i = 0; i < k; i++) {
        if (v <= breaks[i + 1]) { idx = i; break; }
      }
      return { color: "#6b7280", weight: 1, fillOpacity: 0.78, fillColor: getColor(idx, k) };
    }

    function render(varName) {
      if (!geoData) return;

      // 원본 값 추출
      const rawVals = geoData.features
        .map(f => f.properties[varName])
        .filter(v => typeof v === "number" && !Number.isNaN(v));

      if (rawVals.length === 0) {
        alert(`'${varName}' 변수에 유효한 숫자값이 없습니다.`);
        return;
      }

      // 정규화 적용
      let vals = rawVals;
      if (isNormalized) {
        const allVals = geoData.features.map(f => f.properties[varName]);
        const normalized = normalizeToRange(allVals);
        
        // 정규화된 값을 각 feature의 properties에 임시 저장
        geoData.features.forEach((f, idx) => {
          f.properties[varName + '_normalized'] = normalized[idx];
        });
        
        vals = normalized.filter(v => typeof v === "number" && !Number.isNaN(v));
      }

      const uniq = Array.from(new Set(vals)).length;
      const kEff = Math.max(2, Math.min(K_VALUE, uniq));
      const breaks = computeNaturalBreaks(vals, kEff); // kEff+1

      if (geoLayer) geoLayer.remove();

      geoLayer = L.geoJSON(geoData, {
        style: (f) => styleFeature(f, varName, breaks, kEff),
        onEachFeature: (feature, layer) => {
          const nm = feature.properties[NAME_FIELD] ?? "";
          let v = feature.properties[varName];
          let displayValue = v;
          
          // 툴팁에 표시할 값 결정
          if (isNormalized && feature.properties[varName + '_normalized'] !== undefined) {
            displayValue = feature.properties[varName + '_normalized'];
          }
          
          const label = isNormalized ? `${varName} (정규화)` : varName;
          layer.bindTooltip(`<b>${nm}</b><br/>${label}: ${fmt(displayValue)}`, { sticky: true });
        }
      }).addTo(map);

      try {
        map.fitBounds(geoLayer.getBounds(), { padding: [14, 14] });
      } catch (e) {}

      buildLegend(breaks, kEff, varName);
    }

    function populateVarsFromGeoJSON(geojson) {
      const props = geojson.features?.[0]?.properties || {};
      const candidates = Object.keys(props).filter(k => 
        k !== NAME_FIELD && 
        k !== "join_key" && 
        !k.endsWith("_normalized") // 정규화된 임시 필드 제외
      );
      const vars = candidates.filter(vn =>
        geojson.features.some(f => typeof f.properties[vn] === "number" && !Number.isNaN(f.properties[vn]))
      );
      return vars;
    }

    async function init() {
      const res = await fetch(GEOJSON_URL);
      geoData = await res.json();

      const varSelect = document.getElementById("varSelect");
      const resetBtn = document.getElementById("resetBtn");
      const normalizeToggle = document.getElementById("normalizeToggle");
      const normalizeStatus = document.getElementById("normalizeStatus");

      const vars = populateVarsFromGeoJSON(geoData);
      if (vars.length === 0) {
        varSelect.innerHTML = `<option value="">(표시할 변수가 없습니다)</option>`;
        return;
      }

      varSelect.innerHTML = vars.map(v => `<option value="${v}">${v}</option>`).join("");

      const defaultVar = vars.includes("인구밀도") ? "인구밀도" : vars[0];
      varSelect.value = defaultVar;

      render(defaultVar);

      // 변수 선택 변경 시
      varSelect.addEventListener("change", () => render(varSelect.value));

      // 지도 초기화 버튼
      resetBtn.addEventListener("click", () => {
        if (geoLayer) map.fitBounds(geoLayer.getBounds(), { padding: [14, 14] });
      });

      // 정규화 토글
      normalizeToggle.addEventListener("click", () => {
        isNormalized = !isNormalized;
        normalizeToggle.classList.toggle("active");
        normalizeStatus.textContent = isNormalized ? "ON" : "OFF";
        render(varSelect.value);
      });
    }

    init();
  </script>
</body>
</html>
